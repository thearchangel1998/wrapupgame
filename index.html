<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game: Guess the Translator (Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff; /* sky-50 */
        }
        .game-container {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            padding: 2rem;
            text-align: center;
            max-width: 600px;
            width: 95%;
            transition: all 0.3s ease-in-out;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: none;
            display: block;
            width: 100%;
            margin-top: 1rem;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-primary { background-color: #0ea5e9; color: white; }
        .btn-secondary { background-color: #0d9488; color: white; }
        .btn-gray { background-color: #64748b; color: white;}
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #feedback.correct { color: #16a34a; }
        #feedback.incorrect { color: #dc2626; }
        #english-line { font-size: 1.5rem; font-style: italic; color: #1e293b; padding: 1.5rem; background-color: #f8fafc; border-radius: 1rem; border: 1px solid #e2e8f0; }
        #vietnamese-line { font-size: 1rem; color: #64748b; margin-bottom: 1rem; }
        #analysis-box { background-color: #f1f5f9; border-radius: 0.75rem; padding: 1rem; margin-top: 1.5rem; text-align: left; border-left: 4px solid #fb923c; font-style: italic; }
        .timer { font-weight: 600; color: #475569; }
        #player-name-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        .table-container { max-height: 400px; overflow-y: auto; }
        .bonus-popup {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            animation: fadeIn 0.3s ease;
        }
        .bonus-popup-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            transform: scale(0.95);
            animation: scaleIn 0.3s ease forwards;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="game-container" class="game-container">
        <!-- Screens will be injected here -->
    </div>
    
    <!-- Templates for Screens -->
    <template id="start-screen-template">
        <h1 class="text-4xl font-bold text-slate-800 mb-4">Game: Guess the Translator</h1>
        <p class="text-lg text-slate-600 mb-6">Enter your name to start and get on the leaderboard!</p>
        <input type="text" id="player-name-input" class="w-full p-3 border border-slate-300 rounded-lg text-lg mb-4" placeholder="Enter your full name...">
        <button id="start-btn" class="btn btn-primary text-xl">Start!</button>
        <button id="leaderboard-btn" class="btn btn-secondary">View Leaderboard</button>
    </template>

    <template id="game-screen-template">
        <div class="mb-6 flex justify-between items-center">
            <div>
                 <p id="question-counter" class="text-sm font-semibold text-slate-500 text-left"></p>
                 <p id="score" class="text-xl font-bold text-slate-700 text-left"></p>
            </div>
             <p id="timer" class="timer text-xl"></p>
        </div>
        <p id="vietnamese-line" class="mb-2"></p>
        <p id="english-line" class="mb-6"></p>
        <div id="choices"></div>
        <div id="feedback-container" class="hidden mt-6">
            <p id="feedback" class="text-2xl font-bold mb-4"></p>
            <div id="analysis-box"><p id="analysis-text" class="text-slate-700"></p></div>
        </div>
    </template>

    <template id="end-screen-template">
        <h1 class="text-4xl font-bold text-slate-800 mb-4">Game Over!</h1>
        <p id="final-score" class="text-2xl text-slate-600 mb-2"></p>
        <p id="final-time" class="text-2xl text-slate-600 mb-8"></p>
        <button id="view-leaderboard-end-btn" class="btn btn-secondary">View Leaderboard</button>
        <button id="restart-btn" class="btn btn-primary text-xl">Play Again</button>
    </template>

    <template id="leaderboard-screen-template">
        <h1 class="text-4xl font-bold text-slate-800 mb-4">Leaderboard</h1>
        <div class="table-container">
            <table class="w-full text-left">
                <thead class="bg-slate-100">
                    <tr>
                        <th class="p-3">Rank</th>
                        <th class="p-3">Name</th>
                        <th class="p-3">Score</th>
                        <th class="p-3">Time</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body"></tbody>
            </table>
        </div>
         <button id="back-to-start-btn" class="btn btn-gray mt-6">Back to Start</button>
    </template>
    
    <template id="bonus-popup-template">
        <div class="bonus-popup">
            <div class="bonus-popup-content">
                <h2 id="bonus-title" class="text-3xl font-bold mb-4 text-amber-500">Congratulations!</h2>
                <p id="bonus-message" class="text-xl mb-6"></p>
                <button id="close-bonus-btn" class="btn btn-primary">OK</button>
            </div>
        </div>
    </template>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAC924_uP9ebAZesCDnpy7xVPX82hIey9I",
            authDomain: "test-c24a8.firebaseapp.com",
            projectId: "test-c24a8",
            storageBucket: "test-c24a8.firebasestorage.app",
            messagingSenderId: "87653315057",
            appId: "1:87653315057:web:f86c6bcf9275f500c89450",
            measurementId: "G-YJ7L8E0C9K"
        };
        
        let app, auth, db;
        let firebaseInitialized = false;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            await signInAnonymously(auth);
            firebaseInitialized = true;
            console.log("Firebase initialized.");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
        
        const scoreCollectionPath = `scores`;

        const questions = [
            { vietnamese: "Trong tù không rượu cũng không hoa,", english: '"For prisoners, there is no alcohol nor flowers,"', translator: "Aileen Palmer", analysis: "Analysis: The more generalized opening ('alcohol') and natural phrasing show a focus on creating empathy and being easily understood by English readers." },
            { vietnamese: "Trong tù không rượu cũng không hoa,", english: '"In prison there\'s no alcohol nor flower,"', translator: "Huỳnh Sanh Thông", analysis: "Analysis: This translation is very close to the literal meaning, reflecting a commitment to lexical fidelity and directness." },
            { vietnamese: "Trước cảnh đẹp đêm nay biết làm thế nào?", english: '"But the night is so lovely, how can we celebrate it?"', translator: "Aileen Palmer", analysis: "Analysis: She dramatically rephrases the line into a more poetic, emotionally charged question to inject a sense of longing." },
            { vietnamese: "Từ ngoài khe cửa, trăng ngắm nhà thơ.", english: '"The moon peers through the window at the poet."', translator: "Huỳnh Sanh Thông", analysis: "Analysis: The verb 'peers' is observational, precise, and less anthropomorphic, retaining the original's tone." },
            { vietnamese: "Có đi đường mới biết đường đi khó,", english: '"He knows the road is rough who walks the road."', translator: "Huỳnh Sanh Thông", analysis: "Analysis: He maintains a close syntactic and semantic structure to the original with formal English phrasing, demonstrating formal equivalence." },
            { vietnamese: "Hết lớp núi này lại tiếp đến lớp núi khác;", english: '"After we climb one mountain, another looms into view:"', translator: "Aileen Palmer", analysis: "Analysis: The verb 'looms into view' is a dynamic and poetic choice that conveys the daunting challenge." },
            { vietnamese: "Thì muôn dặm nước non thu cả vào tầm mắt.", english: '"More than ten thousand li can be surveyed at a glance."', translator: "Aileen Palmer", analysis: "Analysis: The phrase 'surveyed at a glance' powerfully conveys the visual scope and sense of achievement." }
        ];
        
        const gameContainer = document.getElementById('game-container');
        let currentQuestionIndex = 0;
        let score = 0;
        let shuffledQuestions = [];
        let timerInterval;
        let startTime;
        let playerName = "";

        const correctSynth = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 } }).toDestination();
        const wrongSynth = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();

        function showScreen(templateId) {
            const template = document.getElementById(templateId);
            gameContainer.innerHTML = template.innerHTML;
            addEventListeners();
        }

        function addEventListeners() {
            const startBtn = document.getElementById('start-btn');
            const restartBtn = document.getElementById('restart-btn');
            const leaderboardBtn = document.getElementById('leaderboard-btn');
            const viewLeaderboardEndBtn = document.getElementById('view-leaderboard-end-btn');
            const backToStartBtn = document.getElementById('back-to-start-btn');

            if (startBtn) startBtn.addEventListener('click', startGame);
            if (restartBtn) restartBtn.addEventListener('click', () => showScreen('start-screen-template'));
            if (leaderboardBtn) {
                leaderboardBtn.addEventListener('click', showLeaderboard);
                if (!firebaseInitialized) {
                    leaderboardBtn.disabled = true;
                    leaderboardBtn.title = "Leaderboard is offline";
                }
            }
            if (viewLeaderboardEndBtn) viewLeaderboardEndBtn.addEventListener('click', showLeaderboard);
            if (backToStartBtn) backToStartBtn.addEventListener('click', () => showScreen('start-screen-template'));
        }

        async function startGame() {
            await Tone.start();
            
            const playerNameInput = document.getElementById('player-name-input');
            playerName = playerNameInput.value.trim();
            if (!playerName) {
                alert("Please enter your name to start!");
                return;
            }

            currentQuestionIndex = 0;
            score = 0;
            shuffledQuestions = questions.sort(() => Math.random() - 0.5);
            showScreen('game-screen-template');
            
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            
            displayQuestion();
        }
        
        function displayQuestion() {
            const feedbackContainer = document.getElementById('feedback-container');
            if (feedbackContainer) feedbackContainer.classList.add('hidden');

            const question = shuffledQuestions[currentQuestionIndex];
            document.getElementById('vietnamese-line').textContent = `Original: ${question.vietnamese}`;
            document.getElementById('english-line').textContent = question.english;
            
            const choicesEl = document.getElementById('choices');
            choicesEl.innerHTML = '';
            ["Aileen Palmer", "Huỳnh Sanh Thông"].forEach(translator => {
                const button = document.createElement('button');
                button.textContent = translator;
                button.classList.add('btn', translator === "Aileen Palmer" ? 'btn-primary' : 'btn-secondary');
                button.addEventListener('click', () => checkAnswer(translator));
                choicesEl.appendChild(button);
            });
            
            updateScoreboard();
        }

        function checkAnswer(chosenTranslator) {
            const correctTranslator = shuffledQuestions[currentQuestionIndex].translator;
            const feedbackEl = document.getElementById('feedback');
            
            if (chosenTranslator === correctTranslator) {
                feedbackEl.textContent = "Correct!";
                feedbackEl.className = 'correct';
                score++;
                correctSynth.triggerAttackRelease("C5", "8n", Tone.now());
            } else {
                feedbackEl.textContent = `Incorrect! The translator was ${correctTranslator}.`;
                feedbackEl.className = 'incorrect';
                wrongSynth.triggerAttackRelease("A2", "8n", Tone.now());
                if (window.navigator && window.navigator.vibrate) {
                    navigator.vibrate(200);
                }
            }
            
            document.getElementById('analysis-text').textContent = shuffledQuestions[currentQuestionIndex].analysis;
            document.getElementById('feedback-container').classList.remove('hidden');
            
            Array.from(document.getElementById('choices').children).forEach(button => button.disabled = true);
            updateScoreboard();

            setTimeout(nextQuestion, 3000); 
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < shuffledQuestions.length) {
                displayQuestion();
            } else {
                endGame();
            }
        }

        async function endGame() {
            clearInterval(timerInterval);
            const elapsedTime = Math.floor((Date.now() - startTime) / 1000);

            showScreen('end-screen-template');
            document.getElementById('final-score').textContent = `Your Score: ${score} / ${shuffledQuestions.length}`;
            document.getElementById('final-time').textContent = `Time: ${formatTime(elapsedTime)}`;
            
            await saveScoreToFirestore(playerName, score, elapsedTime);
            await determineAndShowBonus(score, elapsedTime);
        }
        
        async function saveScoreToFirestore(name, finalScore, timeInSeconds) {
            if (!firebaseInitialized) return;
            try {
                await addDoc(collection(db, scoreCollectionPath), { name, score: finalScore, time: timeInSeconds, timestamp: serverTimestamp() });
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }

        async function getSortedLeaderboard() {
            if (!firebaseInitialized) return [];
            try {
                const querySnapshot = await getDocs(query(collection(db, scoreCollectionPath)));
                const scores = [];
                querySnapshot.forEach((doc) => scores.push(doc.data()));
                scores.sort((a, b) => b.score - a.score || a.time - b.time);
                return scores;
            } catch (e) {
                console.error("Error getting leaderboard: ", e);
                return [];
            }
        }
        
        async function determineAndShowBonus(playerScore, playerTime) {
            const leaderboard = await getSortedLeaderboard();
            let playerRank = -1;

            // Find the player's rank
            const playerIndex = leaderboard.findIndex(entry => entry.name === playerName && entry.score === playerScore && entry.time === playerTime);
            if (playerIndex !== -1) {
                playerRank = playerIndex + 1;
            }

            let bonusMessage = "Thank you for your cooperation, 1 BONUS for you";
            if (playerRank !== -1 && playerRank <= 3) {
                bonusMessage = "Thank you for your cooperation, 2 BONUSES for you";
            }
            
            // Show the popup
            const popupTemplate = document.getElementById('bonus-popup-template');
            const popupNode = popupTemplate.content.cloneNode(true);
            popupNode.getElementById('bonus-message').textContent = bonusMessage;
            document.body.appendChild(popupNode);

            document.getElementById('close-bonus-btn').addEventListener('click', () => {
                document.querySelector('.bonus-popup').remove();
            });
        }

        async function showLeaderboard() {
            showScreen('leaderboard-screen-template');
            const leaderboardBody = document.getElementById('leaderboard-body');
            if (!firebaseInitialized) {
                leaderboardBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">Leaderboard is unavailable.</td></tr>';
                return;
            }
            leaderboardBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">Loading...</td></tr>';
            
            const scores = await getSortedLeaderboard();

            leaderboardBody.innerHTML = '';
            if (scores.length === 0) {
                 leaderboardBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">No one has played yet. Be the first!</td></tr>';
                 return;
            }

            scores.forEach((data, index) => {
                const row = `
                    <tr class="border-b">
                        <td class="p-3">${index + 1}</td>
                        <td class="p-3 font-semibold">${data.name}</td>
                        <td class="p-3">${data.score}</td>
                        <td class="p-3">${formatTime(data.time)}</td>
                    </tr>
                `;
                leaderboardBody.innerHTML += row;
            });
        }

        function updateScoreboard() {
            document.getElementById('score').textContent = `Score: ${score}`;
            document.getElementById('question-counter').textContent = `Question ${currentQuestionIndex + 1} / ${shuffledQuestions.length}`;
        }
        
        function updateTimer() {
            const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('timer').textContent = formatTime(elapsedTime);
        }

        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }
        
        // Initial load
        showScreen('start-screen-template');

    </script>
</body>
</html>
